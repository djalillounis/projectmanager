{% extends "base.html" %}
{% load formatting %}
{% block title %}Project Details{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Project Title + Actions -->
  <div class="d-flex justify-content-between align-items-center">
    <h1 id="project-title">{{ project.name }}</h1>
    <div>
      <a href="{% url 'project_list' %}" class="btn btn-secondary me-2">Back to Projects</a>
      <button class="btn btn-info" onclick="alert('Export feature coming soon!')">Export</button>
    </div>
  </div>

  <!-- Nav Tabs -->
  <ul class="nav nav-tabs mt-4" id="projectTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab">Tasks</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="adoption-tab" data-bs-toggle="tab" data-bs-target="#adoption" type="button" role="tab">Adoption</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="contacts-tab" data-bs-toggle="tab" data-bs-target="#contacts" type="button" role="tab">Contacts</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#project-info" type="button" role="tab">Project Info</button>
    </li>
  </ul>

  <div class="d-flex justify-content-end mb-3">
    {% if show_closed %}
      <a href="?show_closed=0" class="btn btn-outline-secondary btn-sm">Hide Completed/Cancelled</a>
    {% else %}
      <a href="?show_closed=1" class="btn btn-outline-secondary btn-sm">Show All Statuses</a>
    {% endif %}
  </div>

  <div class="tab-content p-3 border border-top-0" id="projectTabContent">
    <!-- Tasks Tab -->
    <div class="tab-pane fade show active" id="tasks" role="tabpanel">
      <h4>Tasks <a href="{% url 'item_create' project.id %}?item_type=task" class="btn btn-sm btn-secondary ms-2">+</a></h4>
      {% include 'partials/item_table.html' with items=tasks %}
      <h4 class="mt-4">Sub-Projects <a href="{% url 'item_create' project.id %}?item_type=sub_project" class="btn btn-sm btn-secondary ms-2">+</a></h4>
      {% include 'partials/item_table.html' with items=sub_projects %}
      <h4 class="mt-4">Activities <a href="{% url 'item_create' project.id %}?item_type=activity" class="btn btn-sm btn-secondary ms-2">+</a></h4>
      {% include 'partials/item_table.html' with items=activities %}
    </div>

    <!-- Adoption Tab -->
    <div class="tab-pane fade" id="adoption" role="tabpanel">
      <p class="text-muted">This feature is coming soon.</p>
    </div>

    <!-- Contacts Tab -->
    <div class="tab-pane fade" id="contacts" role="tabpanel">
      <h4 class="mb-3">Project Contacts</h4>
      <div id="contacts-container" class="row">
        {% for contact in contacts %}
        {% include "partials/contact_card.html" with contact=contact %}
        {% endfor %}
      </div>

      <hr>
      <h5>Add New Contact</h5>
      <form id="contact-form">
        {% csrf_token %}
        <div class="row">
          <div class="col-md-4">
            <input type="text" name="name" placeholder="Name" class="form-control mb-2" required>
            <input type="email" name="email" placeholder="Email" class="form-control mb-2">
            <input type="text" name="phone" placeholder="Phone" class="form-control mb-2">
          </div>
          <div class="col-md-4">
            <input type="text" name="role" placeholder="Role" class="form-control mb-2">
            <select name="contact_type" class="form-control mb-2">
              <option value="internal">Internal</option>
              <option value="external" selected>External</option>
            </select>
            <button type="submit" class="btn btn-primary">Add Contact</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Project Info Tab -->
    <div class="tab-pane fade" id="project-info" role="tabpanel">
      <h4>Edit Project Info</h4>
      <form id="project-info-form">
        {% csrf_token %}
        <div class="mb-3">
          <label for="project-name" class="form-label">Project Name</label>
          <input type="text" id="project-name" name="name" class="form-control" value="{{ project.name }}">
        </div>
        <div class="mb-3">
          <label for="project-description" class="form-label">Description</label>
          <textarea id="project-description" name="description" class="form-control">{{ project.description }}</textarea>
        </div>
        <button type="submit" class="btn btn-success">Save Changes</button>
        <a href="{% url 'project_delete' project.id %}" class="btn btn-outline-danger ms-2">Delete Project</a>
      </form>
    </div>
  </div>
</div>

<!-- Delete Contact Modal -->
<div class="modal fade" id="deleteContactModal" tabindex="-1" aria-labelledby="deleteContactModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteContactModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">Are you sure you want to delete this contact?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>


<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  // === ADD NEW CONTACT ===
  document.getElementById("contact-form").addEventListener("submit", function (e) {
    e.preventDefault();
    const form = this;
    const formData = new FormData(form);
  
    fetch("{% url 'add_contact' project.id %}", {
      method: "POST",
      headers: { "X-CSRFToken": getCookie("csrftoken") },
      body: formData
    }).then(res => res.json())
      .then(data => {
        if (data.success && data.contact_html) {
          const container = document.getElementById("contacts-container");
          const temp = document.createElement("div");
          temp.innerHTML = data.contact_html.trim();
          container.prepend(temp.firstElementChild);
  
          form.reset();
  
          const alert = document.createElement("div");
          alert.className = "alert alert-success mt-2";
          alert.innerText = "Contact added successfully!";
          form.prepend(alert);
          setTimeout(() => alert.remove(), 3000);
  
          rebindEditEvents();  // Rebind edit events for new contact
        } else {
          alert("Error: " + JSON.stringify(data.errors || "Unexpected error"));
        }
      });
  });
  
  // === EDIT CONTACT ===
  function rebindEditEvents() {
    document.querySelectorAll(".edit-contact-btn").forEach(btn => {
      btn.onclick = function () {
        const card = btn.closest(".contact-card");
        const panel = card.querySelector(".edit-contact-panel");
        panel.classList.toggle("d-none");
      };
    });
  
    document.querySelectorAll(".edit-contact-form").forEach(form => {
      form.onsubmit = function (e) {
        e.preventDefault();
        const contactId = form.dataset.id;
        const formData = new FormData(form);
  
        fetch(`/contacts/update/${contactId}/`, {
          method: "POST",
          headers: { "X-CSRFToken": getCookie("csrftoken") },
          body: formData
        }).then(res => res.json()).then(data => {
          if (data.success) {
            const panel = form.closest(".edit-contact-panel");
            panel.classList.add("d-none");
  
            const alert = document.createElement("div");
            alert.className = "alert alert-success mt-2";
            alert.innerText = "Contact updated successfully!";
            form.parentElement.prepend(alert);
            setTimeout(() => alert.remove(), 3000);
          } else {
            alert("Update failed.");
          }
        });
      };
  
      // === DELETE CONTACT from edit panel ===
      const deleteBtn = form.querySelector(".delete-contact-btn");
      deleteBtn.onclick = function () {
        const contactId = form.dataset.id;
  
        if (!confirm("Are you sure you want to delete this contact?")) return;
  
        fetch(`/contacts/delete/${contactId}/`, {
          method: "POST",
          headers: { "X-CSRFToken": getCookie("csrftoken") }
        }).then(res => res.json()).then(data => {
          if (data.success) {
            document.getElementById(`contact-${contactId}`).remove();
          } else {
            alert("Failed to delete contact.");
          }
        });
      };
    });
  }
  
  // === PROJECT INFO UPDATE ===
  document.getElementById("project-info-form").addEventListener("submit", function (e) {
    e.preventDefault();
    const data = {
      name: document.getElementById("project-name").value,
      description: document.getElementById("project-description").value
    };
  
    fetch("{% url 'update_project_info' project.id %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: JSON.stringify(data)
    }).then(res => res.json()).then(data => {
      if (data.success) {
        document.getElementById("project-title").textContent = data.name || data.description;
        alert("Project updated.");
      }
    });
  });
  
  // Initial binding
  rebindEditEvents();
  </script>
  